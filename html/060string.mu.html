<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<title>Mu - 060string.mu</title>
<meta name="Generator" content="Vim/7.4">
<meta name="plugin-version" content="vim7.4_v1">
<meta name="syntax" content="none">
<meta name="settings" content="use_css,pre_wrap,no_foldcolumn,expand_tabs,prevent_copy=">
<meta name="colorscheme" content="minimal">
<style type="text/css">
<!--
pre { white-space: pre-wrap; font-family: monospace; color: #d0d0d0; background-color: #000000; }
body { font-family: monospace; color: #d0d0d0; background-color: #000000; }
* { font-size: 1em; }
.CommentedCode { color: #6c6c6c; }
.muRecipe { color: #ff8700; }
.muScenario { color: #00af00; }
.Delimiter { color: #c000c0; }
.Comment { color: #8080ff; }
.Constant { color: #008080; }
.Special { color: #ff6060; }
.Identifier { color: #008080; }
-->
</style>

<script type='text/javascript'>
<!--

-->
</script>
</head>
<body>
<pre id='vimCodeElement'>
<span class="Comment"># Some useful helpers for dealing with strings.</span>

<span class="muRecipe">recipe</span> string-equal [
  <span class="Identifier">default-space</span>:address:array:location<span class="Special"> &lt;- </span>new location:type, <span class="Constant">30:literal</span>
  a:address:array:character<span class="Special"> &lt;- </span><span class="Identifier">next-ingredient</span>
  a-len:number<span class="Special"> &lt;- </span>length a:address:array:character/deref
  b:address:array:character<span class="Special"> &lt;- </span><span class="Identifier">next-ingredient</span>
  b-len:number<span class="Special"> &lt;- </span>length b:address:array:character/deref
  <span class="Comment"># compare lengths</span>
  <span class="Delimiter">{</span>
    trace <span class="Constant">[string-equal]</span>, <span class="Constant">[comparing lengths]</span>
    length-equal?:boolean<span class="Special"> &lt;- </span>equal a-len:number, b-len:number
    <span class="Identifier">break-if</span> length-equal?:boolean
    <span class="Identifier">reply</span> <span class="Constant">0:literal</span>
  <span class="Delimiter">}</span>
  <span class="Comment"># compare each corresponding character</span>
  trace <span class="Constant">[string-equal]</span>, <span class="Constant">[comparing characters]</span>
  i:number<span class="Special"> &lt;- </span>copy <span class="Constant">0:literal</span>
  <span class="Delimiter">{</span>
    done?:boolean<span class="Special"> &lt;- </span>greater-or-equal i:number, a-len:number
    <span class="Identifier">break-if</span> done?:boolean
    a2:character<span class="Special"> &lt;- </span>index a:address:array:character/deref, i:number
    b2:character<span class="Special"> &lt;- </span>index b:address:array:character/deref, i:number
    <span class="Delimiter">{</span>
      chars-match?:boolean<span class="Special"> &lt;- </span>equal a2:character, b2:character
      <span class="Identifier">break-if</span> chars-match?:boolean
      <span class="Identifier">reply</span> <span class="Constant">0:literal</span>
    <span class="Delimiter">}</span>
    i:number<span class="Special"> &lt;- </span>add i:number, <span class="Constant">1:literal</span>
    <span class="Identifier">loop</span>
  <span class="Delimiter">}</span>
  <span class="Identifier">reply</span> <span class="Constant">1:literal</span>
]

<span class="muScenario">scenario</span> string-equal-reflexive [
  run [
    <span class="Identifier">default-space</span>:address:array:location<span class="Special"> &lt;- </span>new location:type, <span class="Constant">30:literal</span>
    x:address:array:character<span class="Special"> &lt;- </span>new <span class="Constant">[abc]</span>
    3:boolean/<span class="Special">raw &lt;- </span>string-equal x:address:array:character, x:address:array:character
  ]
  memory-should-contain [
    3<span class="Special"> &lt;- </span>1  <span class="Comment"># x == x for all x</span>
  ]
]

<span class="muScenario">scenario</span> string-equal-identical [
  run [
    <span class="Identifier">default-space</span>:address:array:location<span class="Special"> &lt;- </span>new location:type, <span class="Constant">30:literal</span>
    x:address:array:character<span class="Special"> &lt;- </span>new <span class="Constant">[abc]</span>
    y:address:array:character<span class="Special"> &lt;- </span>new <span class="Constant">[abc]</span>
    3:boolean/<span class="Special">raw &lt;- </span>string-equal x:address:array:character, y:address:array:character
  ]
  memory-should-contain [
    3<span class="Special"> &lt;- </span>1  <span class="Comment"># abc == abc</span>
  ]
]

<span class="muScenario">scenario</span> string-equal-distinct-lengths [
  run [
    <span class="Identifier">default-space</span>:address:array:location<span class="Special"> &lt;- </span>new location:type, <span class="Constant">30:literal</span>
    x:address:array:character<span class="Special"> &lt;- </span>new <span class="Constant">[abc]</span>
    y:address:array:character<span class="Special"> &lt;- </span>new <span class="Constant">[abcd]</span>
    3:boolean/<span class="Special">raw &lt;- </span>string-equal x:address:array:character, y:address:array:character
  ]
  memory-should-contain [
    3<span class="Special"> &lt;- </span>0  <span class="Comment"># abc != abcd</span>
  ]
  trace-should-contain [
    string-equal: comparing lengths
  ]
  trace-should-not-contain [
    string-equal: comparing characters
  ]
]

<span class="muScenario">scenario</span> string-equal-with-empty [
  run [
    <span class="Identifier">default-space</span>:address:array:location<span class="Special"> &lt;- </span>new location:type, <span class="Constant">30:literal</span>
    x:address:array:character<span class="Special"> &lt;- </span>new <span class="Constant">[]</span>
    y:address:array:character<span class="Special"> &lt;- </span>new <span class="Constant">[abcd]</span>
    3:boolean/<span class="Special">raw &lt;- </span>string-equal x:address:array:character, y:address:array:character
  ]
  memory-should-contain [
    3<span class="Special"> &lt;- </span>0  <span class="Comment"># &quot;&quot; != abcd</span>
  ]
]

<span class="muScenario">scenario</span> string-equal-common-lengths-but-distinct [
  run [
    <span class="Identifier">default-space</span>:address:array:location<span class="Special"> &lt;- </span>new location:type, <span class="Constant">30:literal</span>
    x:address:array:character<span class="Special"> &lt;- </span>new <span class="Constant">[abc]</span>
    y:address:array:character<span class="Special"> &lt;- </span>new <span class="Constant">[abd]</span>
    3:boolean/<span class="Special">raw &lt;- </span>string-equal x:address:array:character, y:address:array:character
  ]
  memory-should-contain [
    3<span class="Special"> &lt;- </span>0  <span class="Comment"># abc != abd</span>
  ]
]

<span class="Comment"># A new type to help incrementally construct strings.</span>
container buffer [
  length:number
  data:address:array:character
]

<span class="muRecipe">recipe</span> init-buffer [
  <span class="Identifier">default-space</span>:address:array:location<span class="Special"> &lt;- </span>new location:type, <span class="Constant">30:literal</span>
<span class="CommentedCode">#?   $print default-space:address:array:location, [</span>
<span class="CommentedCode">#? ]</span>
  result:address:buffer<span class="Special"> &lt;- </span>new buffer:type
  len:address:number<span class="Special"> &lt;- </span>get-address result:address:buffer/deref, length:offset
  len:address:number/deref<span class="Special"> &lt;- </span>copy <span class="Constant">0:literal</span>
  s:address:address:array:character<span class="Special"> &lt;- </span>get-address result:address:buffer/deref, data:offset
  capacity:number<span class="Special"> &lt;- </span><span class="Identifier">next-ingredient</span>
  s:address:address:array:character/deref<span class="Special"> &lt;- </span>new character:type, capacity:number
<span class="CommentedCode">#?   $print s:address:address:array:character/deref, [</span>
<span class="CommentedCode">#? ]</span>
  <span class="Identifier">reply</span> result:address:buffer
]

<span class="muRecipe">recipe</span> grow-buffer [
  <span class="Identifier">default-space</span>:address:array:location<span class="Special"> &lt;- </span>new location:type, <span class="Constant">30:literal</span>
  in:address:buffer<span class="Special"> &lt;- </span><span class="Identifier">next-ingredient</span>
  <span class="Comment"># double buffer size</span>
  x:address:address:array:character<span class="Special"> &lt;- </span>get-address in:address:buffer/deref, data:offset
  oldlen:number<span class="Special"> &lt;- </span>length x:address:address:array:character/deref/deref
  newlen:number<span class="Special"> &lt;- </span>multiply oldlen:number, <span class="Constant">2:literal</span>
  olddata:address:array:character<span class="Special"> &lt;- </span>copy x:address:address:array:character/deref
  x:address:address:array:character/deref<span class="Special"> &lt;- </span>new character:type, newlen:number
  <span class="Comment"># copy old contents</span>
  i:number<span class="Special"> &lt;- </span>copy <span class="Constant">0:literal</span>
  <span class="Delimiter">{</span>
    done?:boolean<span class="Special"> &lt;- </span>greater-or-equal i:number, oldlen:number
    <span class="Identifier">break-if</span> done?:boolean
    src:character<span class="Special"> &lt;- </span>index olddata:address:array:character/deref, i:number
    dest:address:character<span class="Special"> &lt;- </span>index-address x:address:address:array:character/deref/deref, i:number
    dest:address:character/deref<span class="Special"> &lt;- </span>copy src:character
    i:number<span class="Special"> &lt;- </span>add i:number, <span class="Constant">1:literal</span>
    <span class="Identifier">loop</span>
  <span class="Delimiter">}</span>
  <span class="Identifier">reply</span> in:address:buffer
]

<span class="muRecipe">recipe</span> buffer-full? [
  <span class="Identifier">default-space</span>:address:array:location<span class="Special"> &lt;- </span>new location:type, <span class="Constant">30:literal</span>
  in:address:buffer<span class="Special"> &lt;- </span><span class="Identifier">next-ingredient</span>
  len:number<span class="Special"> &lt;- </span>get in:address:buffer/deref, length:offset
  s:address:array:character<span class="Special"> &lt;- </span>get in:address:buffer/deref, data:offset
  capacity:number<span class="Special"> &lt;- </span>length s:address:array:character/deref
  result:boolean<span class="Special"> &lt;- </span>greater-or-equal len:number, capacity:number
  <span class="Identifier">reply</span> result:boolean
]

<span class="Comment"># in:address:buffer &lt;- buffer-append in:address:buffer, c:character</span>
<span class="muRecipe">recipe</span> buffer-append [
  <span class="Identifier">default-space</span>:address:array:location<span class="Special"> &lt;- </span>new location:type, <span class="Constant">30:literal</span>
  in:address:buffer<span class="Special"> &lt;- </span><span class="Identifier">next-ingredient</span>
  c:character<span class="Special"> &lt;- </span><span class="Identifier">next-ingredient</span>
  <span class="Delimiter">{</span>
    <span class="Comment"># grow buffer if necessary</span>
    full?:boolean<span class="Special"> &lt;- </span>buffer-full? in:address:buffer
    <span class="Identifier">break-unless</span> full?:boolean
    in:address:buffer<span class="Special"> &lt;- </span>grow-buffer in:address:buffer
  <span class="Delimiter">}</span>
  len:address:number<span class="Special"> &lt;- </span>get-address in:address:buffer/deref, length:offset
  s:address:array:character<span class="Special"> &lt;- </span>get in:address:buffer/deref, data:offset
  dest:address:character<span class="Special"> &lt;- </span>index-address s:address:array:character/deref, len:address:number/deref
  dest:address:character/deref<span class="Special"> &lt;- </span>copy c:character
  len:address:number/deref<span class="Special"> &lt;- </span>add len:address:number/deref, <span class="Constant">1:literal</span>
  <span class="Identifier">reply</span> in:address:buffer/same-as-ingredient:0
]

<span class="muScenario">scenario</span> buffer-append-works [
  run [
    <span class="Identifier">default-space</span>:address:array:location<span class="Special"> &lt;- </span>new location:type, <span class="Constant">30:literal</span>
    x:address:buffer<span class="Special"> &lt;- </span>init-buffer <span class="Constant">3:literal</span>
    s1:address:array:character<span class="Special"> &lt;- </span>get x:address:buffer/deref, data:offset
    x:address:buffer<span class="Special"> &lt;- </span>buffer-append x:address:buffer, <span class="Constant">97:literal</span>  <span class="Comment"># 'a'</span>
    x:address:buffer<span class="Special"> &lt;- </span>buffer-append x:address:buffer, <span class="Constant">98:literal</span>  <span class="Comment"># 'b'</span>
    x:address:buffer<span class="Special"> &lt;- </span>buffer-append x:address:buffer, <span class="Constant">99:literal</span>  <span class="Comment"># 'c'</span>
    s2:address:array:character<span class="Special"> &lt;- </span>get x:address:buffer/deref, data:offset
    1:boolean/<span class="Special">raw &lt;- </span>equal s1:address:array:character, s2:address:array:character
<span class="CommentedCode">#?     $print s2:address:array:character, [</span>
<span class="CommentedCode">#? ]</span>
<span class="CommentedCode">#?     $print 1060:number/raw, [</span>
<span class="CommentedCode">#? ]</span>
<span class="CommentedCode">#?     $print 1061:number/raw, [</span>
<span class="CommentedCode">#? ]</span>
<span class="CommentedCode">#?     $print 1062:number/raw, [</span>
<span class="CommentedCode">#? ]</span>
<span class="CommentedCode">#?     $print 1063:number/raw, [</span>
<span class="CommentedCode">#? ]</span>
<span class="CommentedCode">#?     $print 1064:number/raw, [</span>
<span class="CommentedCode">#? ]</span>
<span class="CommentedCode">#?     $print 1065:number/raw, [</span>
<span class="CommentedCode">#? ]</span>
    2:array:character/<span class="Special">raw &lt;- </span>copy s2:address:array:character/deref
   <span class="Identifier"> +buffer-filled</span>
    x:address:buffer<span class="Special"> &lt;- </span>buffer-append x:address:buffer, <span class="Constant">100:literal</span>  <span class="Comment"># 'd'</span>
    s3:address:array:character<span class="Special"> &lt;- </span>get x:address:buffer/deref, data:offset
    10:boolean/<span class="Special">raw &lt;- </span>equal s1:address:array:character, s3:address:array:character
    11:number/<span class="Special">raw &lt;- </span>get x:address:buffer/deref, length:offset
    12:array:character/<span class="Special">raw &lt;- </span>copy s3:address:array:character/deref
  ]
  memory-should-contain [
    <span class="Comment"># before +buffer-filled</span>
    1<span class="Special"> &lt;- </span>1   <span class="Comment"># no change in data pointer</span>
    2<span class="Special"> &lt;- </span>3   <span class="Comment"># size of data</span>
    3<span class="Special"> &lt;- </span>97  <span class="Comment"># data</span>
    4<span class="Special"> &lt;- </span>98
    5<span class="Special"> &lt;- </span>99
    <span class="Comment"># in the end</span>
    10<span class="Special"> &lt;- </span>0   <span class="Comment"># data pointer has grown</span>
    11<span class="Special"> &lt;- </span>4   <span class="Comment"># final length</span>
    12<span class="Special"> &lt;- </span>6   <span class="Comment"># but data's capacity has doubled</span>
    13<span class="Special"> &lt;- </span>97  <span class="Comment"># data</span>
    14<span class="Special"> &lt;- </span>98
    15<span class="Special"> &lt;- </span>99
    16<span class="Special"> &lt;- </span>100
    17<span class="Special"> &lt;- </span>0
    18<span class="Special"> &lt;- </span>0
  ]
]

<span class="Comment"># result:address:array:character &lt;- integer-to-decimal-string n:number</span>
<span class="muRecipe">recipe</span> integer-to-decimal-string [
  <span class="Identifier">default-space</span>:address:array:location<span class="Special"> &lt;- </span>new location:type, <span class="Constant">30:literal</span>
  n:number<span class="Special"> &lt;- </span><span class="Identifier">next-ingredient</span>
  <span class="Comment"># is it zero?</span>
  <span class="Delimiter">{</span>
    <span class="Identifier">break-if</span> n:number
    result:address:array:character<span class="Special"> &lt;- </span>new <span class="Constant">[0]</span>
    <span class="Identifier">reply</span> result:address:array:character
  <span class="Delimiter">}</span>
  <span class="Comment"># save sign</span>
  negate-result:boolean<span class="Special"> &lt;- </span>copy <span class="Constant">0:literal</span>
  <span class="Delimiter">{</span>
    negative?:boolean<span class="Special"> &lt;- </span>lesser-than n:number, <span class="Constant">0:literal</span>
    <span class="Identifier">break-unless</span> negative?:boolean
    negate-result:boolean<span class="Special"> &lt;- </span>copy <span class="Constant">1:literal</span>
    n:number<span class="Special"> &lt;- </span>multiply n:number,<span class="Identifier"> -1</span>:literal
  <span class="Delimiter">}</span>
  <span class="Comment"># add digits from right to left into intermediate buffer</span>
  tmp:address:buffer<span class="Special"> &lt;- </span>init-buffer <span class="Constant">30:literal</span>
  digit-base:number<span class="Special"> &lt;- </span>copy <span class="Constant">48:literal</span>  <span class="Comment"># '0'</span>
  <span class="Delimiter">{</span>
    done?:boolean<span class="Special"> &lt;- </span>equal n:number, <span class="Constant">0:literal</span>
    <span class="Identifier">break-if</span> done?:boolean
    n:number, digit:number<span class="Special"> &lt;- </span>divide-with-remainder n:number, <span class="Constant">10:literal</span>
    c:character<span class="Special"> &lt;- </span>add digit-base:number, digit:number
    tmp:address:buffer<span class="Special"> &lt;- </span>buffer-append tmp:address:buffer, c:character
    <span class="Identifier">loop</span>
  <span class="Delimiter">}</span>
  <span class="Comment"># add sign</span>
  <span class="Delimiter">{</span>
    <span class="Identifier">break-unless</span> negate-result:boolean
    tmp:address:buffer<span class="Special"> &lt;- </span>buffer-append tmp:address:buffer, <span class="Constant">45:literal</span>  <span class="Comment"># '-'</span>
  <span class="Delimiter">}</span>
  <span class="Comment"># reverse buffer into string result</span>
  len:number<span class="Special"> &lt;- </span>get tmp:address:buffer/deref, length:offset
  buf:address:array:character<span class="Special"> &lt;- </span>get tmp:address:buffer/deref, data:offset
  result:address:array:character<span class="Special"> &lt;- </span>new character:type, len:number
  i:number<span class="Special"> &lt;- </span>subtract len:number, <span class="Constant">1:literal</span>
  j:number<span class="Special"> &lt;- </span>copy <span class="Constant">0:literal</span>
  <span class="Delimiter">{</span>
    <span class="Comment"># while i &gt;= 0</span>
    done?:boolean<span class="Special"> &lt;- </span>lesser-than i:number, <span class="Constant">0:literal</span>
    <span class="Identifier">break-if</span> done?:boolean
    <span class="Comment"># result[j] = tmp[i]</span>
    src:character<span class="Special"> &lt;- </span>index buf:address:array:character/deref, i:number
    dest:address:character<span class="Special"> &lt;- </span>index-address result:address:array:character/deref, j:number
    dest:address:character/deref<span class="Special"> &lt;- </span>copy src:character
    <span class="Comment"># ++i</span>
    i:number<span class="Special"> &lt;- </span>subtract i:number, <span class="Constant">1:literal</span>
    <span class="Comment"># --j</span>
    j:number<span class="Special"> &lt;- </span>add j:number, <span class="Constant">1:literal</span>
    <span class="Identifier">loop</span>
  <span class="Delimiter">}</span>
  <span class="Identifier">reply</span> result:address:array:character
]

<span class="muScenario">scenario</span> integer-to-decimal-digit-zero [
  run [
    1:address:array:character/<span class="Special">raw &lt;- </span>integer-to-decimal-string <span class="Constant">0:literal</span>
    2:array:character/<span class="Special">raw &lt;- </span>copy 1:address:array:character/deref/<span class="Special">raw</span>
  ]
  memory-should-contain [
    2:string<span class="Special"> &lt;- </span><span class="Constant">[0]</span>
  ]
]

<span class="muScenario">scenario</span> integer-to-decimal-digit-positive [
  run [
    1:address:array:character/<span class="Special">raw &lt;- </span>integer-to-decimal-string <span class="Constant">234:literal</span>
    2:array:character/<span class="Special">raw &lt;- </span>copy 1:address:array:character/deref/<span class="Special">raw</span>
  ]
  memory-should-contain [
    2:string<span class="Special"> &lt;- </span><span class="Constant">[234]</span>
  ]
]

<span class="muScenario">scenario</span> integer-to-decimal-digit-negative [
  run [
    1:address:array:character/<span class="Special">raw &lt;- </span>integer-to-decimal-string<span class="Identifier"> -1</span>:literal
    2:array:character/<span class="Special">raw &lt;- </span>copy 1:address:array:character/deref/<span class="Special">raw</span>
  ]
  memory-should-contain [
    2<span class="Special"> &lt;- </span>2
    3<span class="Special"> &lt;- </span>45  <span class="Comment"># '-'</span>
    4<span class="Special"> &lt;- </span>49  <span class="Comment"># '1'</span>
  ]
]

<span class="Comment"># result:address:array:character &lt;- string-append a:address:array:character, b:address:array:character</span>
<span class="muRecipe">recipe</span> string-append [
  <span class="Identifier">default-space</span>:address:array:location<span class="Special"> &lt;- </span>new location:type, <span class="Constant">30:literal</span>
  <span class="Comment"># result = new character[a.length + b.length]</span>
  a:address:array:character<span class="Special"> &lt;- </span><span class="Identifier">next-ingredient</span>
  a-len:number<span class="Special"> &lt;- </span>length a:address:array:character/deref
  b:address:array:character<span class="Special"> &lt;- </span><span class="Identifier">next-ingredient</span>
  b-len:number<span class="Special"> &lt;- </span>length b:address:array:character/deref
  result-len:number<span class="Special"> &lt;- </span>add a-len:number, b-len:number
  result:address:array:character<span class="Special"> &lt;- </span>new character:type, result-len:number
  <span class="Comment"># copy a into result</span>
  result-idx:number<span class="Special"> &lt;- </span>copy <span class="Constant">0:literal</span>
  i:number<span class="Special"> &lt;- </span>copy <span class="Constant">0:literal</span>
  <span class="Delimiter">{</span>
    <span class="Comment"># while i &lt; a.length</span>
    a-done?:boolean<span class="Special"> &lt;- </span>greater-or-equal i:number, a-len:number
    <span class="Identifier">break-if</span> a-done?:boolean
    <span class="Comment"># result[result-idx] = a[i]</span>
    out:address:character<span class="Special"> &lt;- </span>index-address result:address:array:character/deref, result-idx:number
    in:character<span class="Special"> &lt;- </span>index a:address:array:character/deref, i:number
    out:address:character/deref<span class="Special"> &lt;- </span>copy in:character
    <span class="Comment"># ++i</span>
    i:number<span class="Special"> &lt;- </span>add i:number, <span class="Constant">1:literal</span>
    <span class="Comment"># ++result-idx</span>
    result-idx:number<span class="Special"> &lt;- </span>add result-idx:number, <span class="Constant">1:literal</span>
    <span class="Identifier">loop</span>
  <span class="Delimiter">}</span>
  <span class="Comment"># copy b into result</span>
  i:number<span class="Special"> &lt;- </span>copy <span class="Constant">0:literal</span>
  <span class="Delimiter">{</span>
    <span class="Comment"># while i &lt; b.length</span>
    b-done?:boolean<span class="Special"> &lt;- </span>greater-or-equal i:number, b-len:number
    <span class="Identifier">break-if</span> b-done?:boolean
    <span class="Comment"># result[result-idx] = a[i]</span>
    out:address:character<span class="Special"> &lt;- </span>index-address result:address:array:character/deref, result-idx:number
    in:character<span class="Special"> &lt;- </span>index b:address:array:character/deref, i:number
    out:address:character/deref<span class="Special"> &lt;- </span>copy in:character
    <span class="Comment"># ++i</span>
    i:number<span class="Special"> &lt;- </span>add i:number, <span class="Constant">1:literal</span>
    <span class="Comment"># ++result-idx</span>
    result-idx:number<span class="Special"> &lt;- </span>add result-idx:number, <span class="Constant">1:literal</span>
    <span class="Identifier">loop</span>
  <span class="Delimiter">}</span>
  <span class="Identifier">reply</span> result:address:array:character
]

<span class="muScenario">scenario</span> string-append-1 [
  run [
    1:address:array:character/<span class="Special">raw &lt;- </span>new <span class="Constant">[hello,]</span>
    2:address:array:character/<span class="Special">raw &lt;- </span>new <span class="Constant">[ world!]</span>
    3:address:array:character/<span class="Special">raw &lt;- </span>string-append 1:address:array:character/<span class="Special">raw</span>, 2:address:array:character/<span class="Special">raw</span>
    4:array:character/<span class="Special">raw &lt;- </span>copy 3:address:array:character/<span class="Special">raw</span>/deref
  ]
  memory-should-contain [
    4:string<span class="Special"> &lt;- </span><span class="Constant">[hello, world!]</span>
  ]
]

<span class="Comment"># replace underscores in first with remaining args</span>
<span class="Comment"># result:address:array:character &lt;- interpolate template:address:array:character, ...</span>
<span class="muRecipe">recipe</span> interpolate [
  <span class="Identifier">default-space</span>:array:address:location<span class="Special"> &lt;- </span>new location:type, <span class="Constant">60:literal</span>
  template:address:array:character<span class="Special"> &lt;- </span><span class="Identifier">next-ingredient</span>
  <span class="Comment"># compute result-len, space to allocate for result</span>
  tem-len:number<span class="Special"> &lt;- </span>length template:address:array:character/deref
  result-len:number<span class="Special"> &lt;- </span>copy tem-len:number
  <span class="Delimiter">{</span>
    <span class="Comment"># while arg received</span>
    a:address:array:character, arg-received?:boolean<span class="Special"> &lt;- </span><span class="Identifier">next-ingredient</span>
    <span class="Identifier">break-unless</span> arg-received?:boolean
    <span class="Comment"># result-len = result-len + arg.length - 1 for the 'underscore' being replaced</span>
    a-len:number<span class="Special"> &lt;- </span>length a:address:array:character/deref
    result-len:number<span class="Special"> &lt;- </span>add result-len:number, a-len:number
    result-len:number<span class="Special"> &lt;- </span>subtract result-len:number, <span class="Constant">1:literal</span>
    <span class="Identifier">loop</span>
  <span class="Delimiter">}</span>
<span class="CommentedCode">#?   $print tem-len:number, [ ], $result-len:number, [ </span>
<span class="CommentedCode">#? ] #? 1</span>
  rewind-ingredients
  _<span class="Special"> &lt;- </span><span class="Identifier">next-ingredient</span>  <span class="Comment"># skip template</span>
  <span class="Comment"># result = new array:character[result-len]</span>
  result:address:array:character<span class="Special"> &lt;- </span>new character:type, result-len:number
  <span class="Comment"># repeatedly copy sections of template and 'holes' into result</span>
  result-idx:number<span class="Special"> &lt;- </span>copy <span class="Constant">0:literal</span>
  i:number<span class="Special"> &lt;- </span>copy <span class="Constant">0:literal</span>
  <span class="Delimiter">{</span>
    <span class="Comment"># while arg received</span>
    a:address:array:character, arg-received?:boolean<span class="Special"> &lt;- </span><span class="Identifier">next-ingredient</span>
    <span class="Identifier">break-unless</span> arg-received?:boolean
    <span class="Comment"># copy template into result until '_'</span>
    <span class="Delimiter">{</span>
      <span class="Comment"># while i &lt; template.length</span>
      tem-done?:boolean<span class="Special"> &lt;- </span>greater-or-equal i:number, tem-len:number
      <span class="Identifier">break-if</span> tem-done?:boolean,<span class="Identifier"> +done</span>:label
      <span class="Comment"># while template[i] != '_'</span>
      in:character<span class="Special"> &lt;- </span>index template:address:array:character/deref, i:number
      underscore?:boolean<span class="Special"> &lt;- </span>equal in:character, <span class="Constant">95:literal</span>  <span class="Comment"># '_'</span>
      <span class="Identifier">break-if</span> underscore?:boolean
      <span class="Comment"># result[result-idx] = template[i]</span>
      out:address:character<span class="Special"> &lt;- </span>index-address result:address:array:character/deref, result-idx:number
      out:address:character/deref<span class="Special"> &lt;- </span>copy in:character
      <span class="Comment"># ++i</span>
      i:number<span class="Special"> &lt;- </span>add i:number, <span class="Constant">1:literal</span>
      <span class="Comment"># ++result-idx</span>
      result-idx:number<span class="Special"> &lt;- </span>add result-idx:number, <span class="Constant">1:literal</span>
      <span class="Identifier">loop</span>
    <span class="Delimiter">}</span>
    <span class="Comment"># copy 'a' into result</span>
    j:number<span class="Special"> &lt;- </span>copy <span class="Constant">0:literal</span>
    <span class="Delimiter">{</span>
      <span class="Comment"># while j &lt; a.length</span>
      arg-done?:boolean<span class="Special"> &lt;- </span>greater-or-equal j:number, a-len:number
      <span class="Identifier">break-if</span> arg-done?:boolean
      <span class="Comment"># result[result-idx] = a[j]</span>
      in:character<span class="Special"> &lt;- </span>index a:address:array:character/deref, j:number
      out:address:character<span class="Special"> &lt;- </span>index-address result:address:array:character/deref, result-idx:number
      out:address:character/deref<span class="Special"> &lt;- </span>copy in:character
      <span class="Comment"># ++j</span>
      j:number<span class="Special"> &lt;- </span>add j:number, <span class="Constant">1:literal</span>
      <span class="Comment"># ++result-idx</span>
      result-idx:number<span class="Special"> &lt;- </span>add result-idx:number, <span class="Constant">1:literal</span>
      <span class="Identifier">loop</span>
    <span class="Delimiter">}</span>
    <span class="Comment"># skip '_' in template</span>
    i:number<span class="Special"> &lt;- </span>add i:number, <span class="Constant">1:literal</span>
    <span class="Identifier">loop</span>  <span class="Comment"># interpolate next arg</span>
  <span class="Delimiter">}</span>
 <span class="Identifier"> +done</span>
  <span class="Comment"># done with holes; copy rest of template directly into result</span>
  <span class="Delimiter">{</span>
    <span class="Comment"># while i &lt; template.length</span>
    tem-done?:boolean<span class="Special"> &lt;- </span>greater-or-equal i:number, tem-len:number
    <span class="Identifier">break-if</span> tem-done?:boolean
    <span class="Comment"># result[result-idx] = template[i]</span>
    in:character<span class="Special"> &lt;- </span>index template:address:array:character/deref, i:number
    out:address:character<span class="Special"> &lt;- </span>index-address result:address:array:character/deref, result-idx:number
    out:address:character/deref<span class="Special"> &lt;- </span>copy in:character
    <span class="Comment"># ++i</span>
    i:number<span class="Special"> &lt;- </span>add i:number, <span class="Constant">1:literal</span>
    <span class="Comment"># ++result-idx</span>
    result-idx:number<span class="Special"> &lt;- </span>add result-idx:number, <span class="Constant">1:literal</span>
    <span class="Identifier">loop</span>
  <span class="Delimiter">}</span>
  <span class="Identifier">reply</span> result:address:array:character
]

<span class="muScenario">scenario</span> interpolate-works [
<span class="CommentedCode">#?   dump run #? 1</span>
  run [
    1:address:array:character/<span class="Special">raw &lt;- </span>new <span class="Constant">[abc _]</span>
    2:address:array:character/<span class="Special">raw &lt;- </span>new <span class="Constant">[def]</span>
    3:address:array:character/<span class="Special">raw &lt;- </span>interpolate 1:address:array:character/<span class="Special">raw</span>, 2:address:array:character/<span class="Special">raw</span>
    4:array:character/<span class="Special">raw &lt;- </span>copy 3:address:array:character/<span class="Special">raw</span>/deref
  ]
  memory-should-contain [
    4:string<span class="Special"> &lt;- </span><span class="Constant">[abc def]</span>
  ]
]

<span class="muScenario">scenario</span> interpolate-at-start [
  run [
    1:address:array:character/<span class="Special">raw &lt;- </span>new <span class="Constant">[_, hello!]</span>
    2:address:array:character/<span class="Special">raw &lt;- </span>new <span class="Constant">[abc]</span>
    3:address:array:character/<span class="Special">raw &lt;- </span>interpolate 1:address:array:character/<span class="Special">raw</span>, 2:address:array:character/<span class="Special">raw</span>
    4:array:character/<span class="Special">raw &lt;- </span>copy 3:address:array:character/<span class="Special">raw</span>/deref
  ]
  memory-should-contain [
    4:string<span class="Special"> &lt;- </span><span class="Constant">[abc, hello!]</span>
    16<span class="Special"> &lt;- </span>0  <span class="Comment"># out of bounds</span>
  ]
]

<span class="muScenario">scenario</span> interpolate-at-end [
  run [
    1:address:array:character/<span class="Special">raw &lt;- </span>new <span class="Constant">[hello, _]</span>
    2:address:array:character/<span class="Special">raw &lt;- </span>new <span class="Constant">[abc]</span>
    3:address:array:character/<span class="Special">raw &lt;- </span>interpolate 1:address:array:character/<span class="Special">raw</span>, 2:address:array:character/<span class="Special">raw</span>
    4:array:character/<span class="Special">raw &lt;- </span>copy 3:address:array:character/<span class="Special">raw</span>/deref
  ]
  memory-should-contain [
    4:string<span class="Special"> &lt;- </span><span class="Constant">[hello, abc]</span>
  ]
]

<span class="Comment"># result:boolean &lt;- space? c:character</span>
<span class="muRecipe">recipe</span> space? [
  <span class="Identifier">default-space</span>:array:address:location<span class="Special"> &lt;- </span>new location:type, <span class="Constant">30:literal</span>
  c:character<span class="Special"> &lt;- </span><span class="Identifier">next-ingredient</span>
  <span class="Comment"># most common case first</span>
  result:boolean<span class="Special"> &lt;- </span>equal c:character, <span class="Constant">32:literal/space</span>
  <span class="Identifier">jump-if</span> result:boolean,<span class="Identifier"> +reply</span>:label
  result:boolean<span class="Special"> &lt;- </span>equal c:character, <span class="Constant">10:literal/newline</span>
  <span class="Identifier">jump-if</span> result:boolean,<span class="Identifier"> +reply</span>:label
  result:boolean<span class="Special"> &lt;- </span>equal c:character, <span class="Constant">9:literal/tab</span>
  <span class="Identifier">jump-if</span> result:boolean,<span class="Identifier"> +reply</span>:label
  result:boolean<span class="Special"> &lt;- </span>equal c:character, <span class="Constant">13:literal/carriage-return</span>
  <span class="Comment"># remaining uncommon cases in sorted order</span>
  <span class="Comment"># <a href="http://unicode.org">http://unicode.org</a> code-points in unicode-set Z and Pattern_White_Space</span>
  <span class="Identifier">jump-if</span> result:boolean,<span class="Identifier"> +reply</span>:label
  result:boolean<span class="Special"> &lt;- </span>equal c:character, <span class="Constant">11:literal/ctrl-k</span>
  <span class="Identifier">jump-if</span> result:boolean,<span class="Identifier"> +reply</span>:label
  result:boolean<span class="Special"> &lt;- </span>equal c:character, <span class="Constant">12:literal/ctrl-l</span>
  <span class="Identifier">jump-if</span> result:boolean,<span class="Identifier"> +reply</span>:label
  result:boolean<span class="Special"> &lt;- </span>equal c:character, <span class="Constant">133:literal/ctrl-0085</span>
  <span class="Identifier">jump-if</span> result:boolean,<span class="Identifier"> +reply</span>:label
  result:boolean<span class="Special"> &lt;- </span>equal c:character, <span class="Constant">160:literal/no-break-space</span>
  <span class="Identifier">jump-if</span> result:boolean,<span class="Identifier"> +reply</span>:label
  result:boolean<span class="Special"> &lt;- </span>equal c:character, <span class="Constant">5760:literal/ogham-space-mark</span>
  <span class="Identifier">jump-if</span> result:boolean,<span class="Identifier"> +reply</span>:label
  result:boolean<span class="Special"> &lt;- </span>equal c:character, <span class="Constant">8192:literal/en-quad</span>
  <span class="Identifier">jump-if</span> result:boolean,<span class="Identifier"> +reply</span>:label
  result:boolean<span class="Special"> &lt;- </span>equal c:character, <span class="Constant">8193:literal/em-quad</span>
  <span class="Identifier">jump-if</span> result:boolean,<span class="Identifier"> +reply</span>:label
  result:boolean<span class="Special"> &lt;- </span>equal c:character, <span class="Constant">8194:literal/en-space</span>
  <span class="Identifier">jump-if</span> result:boolean,<span class="Identifier"> +reply</span>:label
  result:boolean<span class="Special"> &lt;- </span>equal c:character, <span class="Constant">8195:literal/em-space</span>
  <span class="Identifier">jump-if</span> result:boolean,<span class="Identifier"> +reply</span>:label
  result:boolean<span class="Special"> &lt;- </span>equal c:character, <span class="Constant">8196:literal/three-per-em-space</span>
  <span class="Identifier">jump-if</span> result:boolean,<span class="Identifier"> +reply</span>:label
  result:boolean<span class="Special"> &lt;- </span>equal c:character, <span class="Constant">8197:literal/four-per-em-space</span>
  <span class="Identifier">jump-if</span> result:boolean,<span class="Identifier"> +reply</span>:label
  result:boolean<span class="Special"> &lt;- </span>equal c:character, <span class="Constant">8198:literal/six-per-em-space</span>
  <span class="Identifier">jump-if</span> result:boolean,<span class="Identifier"> +reply</span>:label
  result:boolean<span class="Special"> &lt;- </span>equal c:character, <span class="Constant">8199:literal/figure-space</span>
  <span class="Identifier">jump-if</span> result:boolean,<span class="Identifier"> +reply</span>:label
  result:boolean<span class="Special"> &lt;- </span>equal c:character, <span class="Constant">8200:literal/punctuation-space</span>
  <span class="Identifier">jump-if</span> result:boolean,<span class="Identifier"> +reply</span>:label
  result:boolean<span class="Special"> &lt;- </span>equal c:character, <span class="Constant">8201:literal/thin-space</span>
  <span class="Identifier">jump-if</span> result:boolean,<span class="Identifier"> +reply</span>:label
  result:boolean<span class="Special"> &lt;- </span>equal c:character, <span class="Constant">8202:literal/hair-space</span>
  <span class="Identifier">jump-if</span> result:boolean,<span class="Identifier"> +reply</span>:label
  result:boolean<span class="Special"> &lt;- </span>equal c:character, <span class="Constant">8206:literal/left-to-right</span>
  <span class="Identifier">jump-if</span> result:boolean,<span class="Identifier"> +reply</span>:label
  result:boolean<span class="Special"> &lt;- </span>equal c:character, <span class="Constant">8207:literal/right-to-left</span>
  <span class="Identifier">jump-if</span> result:boolean,<span class="Identifier"> +reply</span>:label
  result:boolean<span class="Special"> &lt;- </span>equal c:character, <span class="Constant">8232:literal/line-separator</span>
  <span class="Identifier">jump-if</span> result:boolean,<span class="Identifier"> +reply</span>:label
  result:boolean<span class="Special"> &lt;- </span>equal c:character, <span class="Constant">8233:literal/paragraph-separator</span>
  <span class="Identifier">jump-if</span> result:boolean,<span class="Identifier"> +reply</span>:label
  result:boolean<span class="Special"> &lt;- </span>equal c:character, <span class="Constant">8239:literal/narrow-no-break-space</span>
  <span class="Identifier">jump-if</span> result:boolean,<span class="Identifier"> +reply</span>:label
  result:boolean<span class="Special"> &lt;- </span>equal c:character, <span class="Constant">8287:literal/medium-mathematical-space</span>
  <span class="Identifier">jump-if</span> result:boolean,<span class="Identifier"> +reply</span>:label
  result:boolean<span class="Special"> &lt;- </span>equal c:character, <span class="Constant">12288:literal/ideographic-space</span>
  <span class="Identifier">jump-if</span> result:boolean,<span class="Identifier"> +reply</span>:label
 <span class="Identifier"> +reply</span>
  <span class="Identifier">reply</span> result:boolean
]

<span class="Comment"># result:address:array:character &lt;- trim s:address:array:character</span>
<span class="muRecipe">recipe</span> trim [
  <span class="Identifier">default-space</span>:array:address:location<span class="Special"> &lt;- </span>new location:type, <span class="Constant">30:literal</span>
  s:address:array:character<span class="Special"> &lt;- </span><span class="Identifier">next-ingredient</span>
  len:number<span class="Special"> &lt;- </span>length s:address:array:character/deref
  <span class="Comment"># left trim: compute start</span>
  start:number<span class="Special"> &lt;- </span>copy <span class="Constant">0:literal</span>
  <span class="Delimiter">{</span>
    <span class="Delimiter">{</span>
      at-end?:boolean<span class="Special"> &lt;- </span>greater-or-equal start:number, len:number
      <span class="Identifier">break-unless</span> at-end?:boolean
      result:address:array:character<span class="Special"> &lt;- </span>new character:type, <span class="Constant">0:literal</span>
      <span class="Identifier">reply</span> result:address:array:character
    <span class="Delimiter">}</span>
    curr:character<span class="Special"> &lt;- </span>index s:address:array:character/deref, start:number
    whitespace?:boolean<span class="Special"> &lt;- </span>space? curr:character
    <span class="Identifier">break-unless</span> whitespace?:boolean
    start:number<span class="Special"> &lt;- </span>add start:number, <span class="Constant">1:literal</span>
    <span class="Identifier">loop</span>
  <span class="Delimiter">}</span>
  <span class="Comment"># right trim: compute end</span>
  end:number<span class="Special"> &lt;- </span>subtract len:number, <span class="Constant">1:literal</span>
  <span class="Delimiter">{</span>
    not-at-start?:boolean<span class="Special"> &lt;- </span>greater-than end:number, start:number
    assert not-at-start?:boolean <span class="Constant">[end ran up against start]</span>
    curr:character<span class="Special"> &lt;- </span>index s:address:array:character/deref, end:number
    whitespace?:boolean<span class="Special"> &lt;- </span>space? curr:character
    <span class="Identifier">break-unless</span> whitespace?:boolean
    end:number<span class="Special"> &lt;- </span>subtract end:number, <span class="Constant">1:literal</span>
    <span class="Identifier">loop</span>
  <span class="Delimiter">}</span>
  <span class="Comment"># result = new character[end+1 - start]</span>
  new-len:number<span class="Special"> &lt;- </span>subtract end:number, start:number,<span class="Identifier"> -1</span>:literal
  result:address:array:character<span class="Special"> &lt;- </span>new character:type, new-len:number
  <span class="Comment"># i = start, j = 0</span>
  i:number<span class="Special"> &lt;- </span>copy start:number
  j:number<span class="Special"> &lt;- </span>copy <span class="Constant">0:literal</span>
  <span class="Delimiter">{</span>
    <span class="Comment"># while i &lt;= end</span>
    done?:boolean<span class="Special"> &lt;- </span>greater-than i:number, end:number
    <span class="Identifier">break-if</span> done?:boolean
    <span class="Comment"># result[j] = s[i]</span>
    src:character<span class="Special"> &lt;- </span>index s:address:array:character/deref, i:number
    dest:address:character<span class="Special"> &lt;- </span>index-address result:address:array:character/deref, j:number
    dest:address:character/deref<span class="Special"> &lt;- </span>copy src:character
    <span class="Comment"># ++i, ++j</span>
    i:number<span class="Special"> &lt;- </span>add i:number, <span class="Constant">1:literal</span>
    j:number<span class="Special"> &lt;- </span>add j:number, <span class="Constant">1:literal</span>
    <span class="Identifier">loop</span>
  <span class="Delimiter">}</span>
  <span class="Identifier">reply</span> result:address:array:character
]

<span class="muScenario">scenario</span> trim-unmodified [
  run [
    1:address:array:character<span class="Special"> &lt;- </span>new <span class="Constant">[abc]</span>
    2:address:array:character<span class="Special"> &lt;- </span>trim 1:address:array:character
    3:array:character<span class="Special"> &lt;- </span>copy 2:address:array:character/deref
  ]
  memory-should-contain [
    3:string<span class="Special"> &lt;- </span><span class="Constant">[abc]</span>
  ]
]

<span class="muScenario">scenario</span> trim-left [
  run [
    1:address:array:character<span class="Special"> &lt;- </span>new <span class="Constant">[  abc]</span>
    2:address:array:character<span class="Special"> &lt;- </span>trim 1:address:array:character
    3:array:character<span class="Special"> &lt;- </span>copy 2:address:array:character/deref
  ]
  memory-should-contain [
    3:string<span class="Special"> &lt;- </span><span class="Constant">[abc]</span>
  ]
]

<span class="muScenario">scenario</span> trim-right [
  run [
    1:address:array:character<span class="Special"> &lt;- </span>new <span class="Constant">[abc  ]</span>
    2:address:array:character<span class="Special"> &lt;- </span>trim 1:address:array:character
    3:array:character<span class="Special"> &lt;- </span>copy 2:address:array:character/deref
  ]
  memory-should-contain [
    3:string<span class="Special"> &lt;- </span><span class="Constant">[abc]</span>
  ]
]

<span class="muScenario">scenario</span> trim-left-right [
  run [
    1:address:array:character<span class="Special"> &lt;- </span>new <span class="Constant">[  abc   ]</span>
    2:address:array:character<span class="Special"> &lt;- </span>trim 1:address:array:character
    3:array:character<span class="Special"> &lt;- </span>copy 2:address:array:character/deref
  ]
  memory-should-contain [
    3:string<span class="Special"> &lt;- </span><span class="Constant">[abc]</span>
  ]
]

<span class="muScenario">scenario</span> trim-newline-tab [
  run [
    1:address:array:character<span class="Special"> &lt;- </span>new <span class="Constant">[  abc</span>
<span class="Constant">]</span>
    2:address:array:character<span class="Special"> &lt;- </span>trim 1:address:array:character
    3:array:character<span class="Special"> &lt;- </span>copy 2:address:array:character/deref
  ]
  memory-should-contain [
    3:string<span class="Special"> &lt;- </span><span class="Constant">[abc]</span>
  ]
]
</pre>
</body>
</html>
<!-- vim: set foldmethod=manual : -->
